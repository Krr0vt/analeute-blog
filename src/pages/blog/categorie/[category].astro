---
import BlogLayout from "../../../layouts/BlogLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  // utilitaire local (accents/espaces → tirets)
  const slugify = (s) =>
    s
      .toString()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .toLowerCase().trim()
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)+/g, "");

  const posts = await getCollection("blog");

  // récupère toutes les catégories présentes
  const labels = posts.map((p) => p.data.category).filter(Boolean);
  const unique = Array.from(new Set(labels));

  // génère une route pour chaque catégorie
  return unique.map((label) => {
    const slug = slugify(label);
    const inCat = posts.filter(
      (p) => p.data.category && slugify(p.data.category) === slug
    );
    return {
      params: { category: slug },
      props: { label, posts: inCat },
    };
  });
}

const { label, posts } = Astro.props;
---
<BlogLayout title={`${label} – Analeute`} description={`Articles classés dans la catégorie ${label}`}>
  <nav class="breadcrumb" aria-label="Fil d’Ariane" style="max-width:700px;margin:1rem auto;padding:0 2rem;">
    <a href="/">← Accueil</a><span class="sep">›</span>
    <a href="/blog/">Blog</a><span class="sep">›</span>
    <span class="current">{label}</span>
  </nav>

  <main style="max-width:700px;margin:2rem auto;padding:0 2rem;">
    <h1>{label}</h1>
    {posts.length === 0 ? (
      <p>Aucun article pour cette catégorie pour le moment.</p>
    ) : (
      <ul style="list-style:none;padding:0;margin:1rem 0;">
        {posts.map(({ slug, data }) => (
          <li style="padding:1rem 0;border-bottom:1px dashed rgba(0,0,0,.12);">
            <a href={`/blog/${slug}/`} style="font-weight:700;color:#4fa4c7;text-decoration:none;border-bottom:1px solid rgba(79,164,199,.4);">
              {data.title}
            </a>
            <div class="meta" style="opacity:.65;font-size:.95rem;margin-top:.25rem;">
              Publié le <time datetime={data.pubDate}>{data.pubDate}</time>
            </div>
            <p class="excerpt" style="margin:.4rem 0 0;opacity:.9;">{data.description}</p>
          </li>
        ))}
      </ul>
    )}
  </main>
</BlogLayout>
